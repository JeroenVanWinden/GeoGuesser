<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geo Guesser Europa ‚Äì ArcGIS JS (stabiele versie + i18n + highscores)</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }
    .ui {
      position: absolute; top: 12px; left: 12px; z-index: 30;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
      border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 12px; width: 360px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .ui h2 { margin: 0 0 8px; font-size: 18px; }
    .row { display: flex; align-items: center; justify-content: space-between; margin: 6px 0; gap: 8px; }
    .city { font-weight: 600; font-size: 16px; }
    .muted { color: #555; font-size: 12px; }
    button { cursor: pointer; border: 0; border-radius: 10px; padding: 10px 12px; font-weight: 600; }
    button.primary { background: #1464f4; color: white; }
    button.ghost { background: #f1f3f5; }
    select { padding: 6px 8px; border-radius: 8px; border: 1px solid #cbd5e1; }
    .actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .scores { margin-top: 10px; max-height: 220px; overflow: auto; border-top: 1px solid #e5e7eb; padding-top: 8px; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { text-align: left; padding: 4px 6px; border-bottom: 1px solid #eee; }
    th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    .banner { position: absolute; right: 12px; top: 12px; background: rgba(0,0,0,0.65); color: #fff; padding: 8px 12px; border-radius: 10px; font-size: 12px; }
    .toast { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(20,100,244,0.95); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; display:none; }
    .footnote { font-size: 11px; color: #6b7280; margin-top: 6px; }
    .nameEntry { display:none; margin-top:10px; padding-top:8px; border-top: 1px solid #e5e7eb; }
    .nameEntry input { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin: 6px 0; }
    .nameEntry .actions { justify-content: flex-end; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div class="banner" id="banner">Klik op de kaart om te raden</div>

  <div class="ui" id="panel">
    <h2 id="title">üéØ Geo Guesser Europa</h2>
    <div class="row">
      <div>
        <label class="muted" for="langSelect">üåê</label>
        <select id="langSelect">
          <option value="nl">Nederlands</option>
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="de">Deutsch</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div id="roundLabel">Ronde:</div>
      <div><span id="round">1</span>/10 ¬∑ <span id="totalLabel">Totaal</span>: <strong id="totalKm">0.0</strong> km</div>
    </div>
    <div class="row">
      <div id="searchLabel">Zoek in de buurt van:</div>
    </div>
    <div class="city" id="cityName">‚Äî</div>
    <div class="muted" id="feedback">Klik op de kaart om je gok te plaatsen.</div>
    <div class="actions">
      <button class="primary" id="nextBtn" disabled>Volgende ronde ‚ñ∂</button>
      <button class="ghost" id="restartBtn">Opnieuw spelen ‚Üª</button>
      <button class="ghost" id="showScoresBtn">Toon highscores ‚≠ê</button>
      </div>

    <!-- Highscore naam-invoer -->
    <div class="nameEntry" id="nameEntry">
      <div id="hsCongrats" class="city" style="font-size:14px; font-weight:600; margin-bottom:4px;">üéâ Nieuwe highscore!</div>
      <label for="playerName" id="hsPrompt" class="muted">Vul je naam in om de score op te slaan:</label>
      <input id="playerName" maxlength="40" placeholder="Jouw naam" />
      <div class="actions">
        <button class="primary" id="saveScoreBtn">Score opslaan</button>
      </div>
    </div>

    <div class="scores" id="scores" style="display:none">
      <table>
        <thead>
          <tr><th id="thRank">#</th><th id="thName">Naam</th><th id="thScore">Score (km)</th><th id="thDate">Datum</th></tr>
        </thead>
        <tbody id="scoresBody"></tbody>
      </table>
      <div class="footnote" id="scoresTip">Tip: scores worden lokaal opgeslagen op dit apparaat.</div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <script>
    /********************
     * 0) i18n
     ********************/
    const I18N = {
      nl: {
        title: 'üéØ Geo Guesser Europa',
        round: 'Ronde', total: 'Totaal', search: 'Zoek in de buurt van:',
        feedbackReady: 'Klik op de kaart om je gok te plaatsen.',
        next: 'Volgende ronde ‚ñ∂', restart: 'Opnieuw spelen ‚Üª', scores: 'Toon highscores ‚≠ê',
        tests: 'Zelftest ‚úÖ', testsTitle: 'Voer snelle zelftests uit',
        thName: 'Naam', thScore: 'Score (km)', thDate: 'Datum', scoresTip: 'Tip: scores worden lokaal opgeslagen op dit apparaat.',
        hsCongrats: 'üéâ Nieuwe highscore!', hsPrompt: 'Vul je naam in om de score op te slaan:', saveScore: 'Score opslaan', namePlaceholder: 'Jouw naam',
        bannerSearch: (city)=>`üéØ Zoek: ${city}`,
        bannerEnd: 'üßÆ Eindscore',
        endMsg: (km)=>`Je totale afwijking is <strong>${km}</strong> km (lager is beter).`,
        toastNew: 'Nieuw spel gestart', toastOver: 'Game voorbij!',
        yourGuess: 'Jouw gok',
        roundDist: (km)=>`Afstand deze ronde: <strong>${km} km</strong>.`,
        roundBanner: (i,km)=>`Ronde ${i}: ${km} km ernaast`
      },
      en: {
        title: 'üéØ Geo Guesser Europe',
        round: 'Round', total: 'Total', search: 'Find near:',
        feedbackReady: 'Click the map to place your guess.',
        next: 'Next round ‚ñ∂', restart: 'Play again ‚Üª', scores: 'Show highscores ‚≠ê',
        tests: 'Self-test ‚úÖ', testsTitle: 'Run quick self tests',
        thName: 'Name', thScore: 'Score (km)', thDate: 'Date', scoresTip: 'Tip: scores are stored locally on this device.',
        hsCongrats: 'üéâ New high score!', hsPrompt: 'Enter your name to save the score:', saveScore: 'Save score', namePlaceholder: 'Your name',
        bannerSearch: (city)=>`üéØ Find: ${city}`,
        bannerEnd: 'üßÆ Final score',
        endMsg: (km)=>`Your total offset is <strong>${km}</strong> km (lower is better).`,
        toastNew: 'New game started', toastOver: 'Game over!',
        yourGuess: 'Your guess',
        roundDist: (km)=>`This round: <strong>${km} km</strong>.`,
        roundBanner: (i,km)=>`Round ${i}: ${km} km off`
      },
      fr: {
        title: 'üéØ Geo Guesser Europe',
        round: 'Manche', total: 'Total', search: 'Cherche pr√®s de¬†:',
        feedbackReady: 'Cliquez sur la carte pour placer votre estimation.',
        next: 'Manche suivante ‚ñ∂', restart: 'Rejouer ‚Üª', scores: 'Voir les meilleurs scores ‚≠ê',
        tests: 'Auto‚Äëtest ‚úÖ', testsTitle: 'Lancer des auto‚Äëtests',
        thName: 'Nom', thScore: 'Score (km)', thDate: 'Date', scoresTip: 'Astuce¬†: les scores sont stock√©s localement sur cet appareil.',
        hsCongrats: 'üéâ Nouveau record¬†!', hsPrompt: 'Entrez votre nom pour enregistrer le score¬†:', saveScore: 'Enregistrer', namePlaceholder: 'Votre nom',
        bannerSearch: (city)=>`üéØ Chercher¬†: ${city}`,
        bannerEnd: 'üßÆ Score final',
        endMsg: (km)=>`√âcart total¬†: <strong>${km}</strong> km (plus bas est mieux).`,
        toastNew: 'Nouvelle partie lanc√©e', toastOver: 'Partie termin√©e¬†!',
        yourGuess: 'Votre estimation',
        roundDist: (km)=>`Cette manche¬†: <strong>${km} km</strong>.`,
        roundBanner: (i,km)=>`Manche ${i}¬†: √©cart de ${km} km`
      },
      de: {
        title: 'üéØ Geo Guesser Europa',
        round: 'Runde', total: 'Gesamt', search: 'Suche in der N√§he von:',
        feedbackReady: 'Klicke auf die Karte, um zu raten.',
        next: 'N√§chste Runde ‚ñ∂', restart: 'Neu spielen ‚Üª', scores: 'Bestenliste anzeigen ‚≠ê',
        tests: 'Selbsttest ‚úÖ', testsTitle: 'Schnelle Selbsttests ausf√ºhren',
        thName: 'Name', thScore: 'Punkte (km)', thDate: 'Datum', scoresTip: 'Tipp: Punkte werden lokal auf diesem Ger√§t gespeichert.',
        hsCongrats: 'üéâ Neuer Highscore!', hsPrompt: 'Gib deinen Namen ein, um zu speichern:', saveScore: 'Speichern', namePlaceholder: 'Dein Name',
        bannerSearch: (city)=>`üéØ Suche: ${city}`,
        bannerEnd: 'üßÆ Endstand',
        endMsg: (km)=>`Gesamtabweichung: <strong>${km}</strong> km (je niedriger, desto besser).`,
        toastNew: 'Neues Spiel gestartet', toastOver: 'Spiel vorbei!',
        yourGuess: 'Dein Tipp',
        roundDist: (km)=>`Diese Runde: <strong>${km} km</strong>.`,
        roundBanner: (i,km)=>`Runde ${i}: ${km} km daneben`
      },
      es: {
        title: 'üéØ Geo Guesser Europa',
        round: 'Ronda', total: 'Total', search: 'Busca cerca de:',
        feedbackReady: 'Haz clic en el mapa para elegir.',
        next: 'Siguiente ronda ‚ñ∂', restart: 'Jugar de nuevo ‚Üª', scores: 'Ver r√©cords ‚≠ê',
        tests: 'Autoprueba ‚úÖ', testsTitle: 'Ejecutar autopruebas r√°pidas',
        thName: 'Nombre', thScore: 'Puntuaci√≥n (km)', thDate: 'Fecha', scoresTip: 'Consejo: las puntuaciones se guardan localmente en este dispositivo.',
        hsCongrats: 'üéâ ¬°Nuevo r√©cord!', hsPrompt: 'Escribe tu nombre para guardar la puntuaci√≥n:', saveScore: 'Guardar', namePlaceholder: 'Tu nombre',
        bannerSearch: (city)=>`üéØ Busca: ${city}`,
        bannerEnd: 'üßÆ Puntuaci√≥n final',
        endMsg: (km)=>`Desviaci√≥n total: <strong>${km}</strong> km (cuanto menor, mejor).`,
        toastNew: '¬°Nueva partida!', toastOver: '¬°Fin de la partida!',
        yourGuess: 'Tu elecci√≥n',
        roundDist: (km)=>`Esta ronda: <strong>${km} km</strong>.`,
        roundBanner: (i,km)=>`Ronda ${i}: a ${km} km`
      }
    };

    const LANG_KEY = 'geoguess-lang';
    function getDefaultLang(){
      const saved = localStorage.getItem(LANG_KEY);
      if(saved && I18N[saved]) return saved;
      const nav = (navigator.language||'nl').slice(0,2);
      return I18N[nav] ? nav : 'nl';
    }
    let CUR_LANG = getDefaultLang();
    function T(){ return I18N[CUR_LANG]; }
    function applyI18n(){
      const t = T();
      document.getElementById('title').textContent = t.title;
      document.getElementById('roundLabel').textContent = t.round + ':';
      document.getElementById('totalLabel').textContent = t.total;
      document.getElementById('searchLabel').textContent = t.search;
      document.getElementById('feedback').textContent = t.feedbackReady;
      document.getElementById('nextBtn').textContent = t.next;
      document.getElementById('restartBtn').textContent = t.restart;
      document.getElementById('showScoresBtn').textContent = t.scores;
      document.getElementById('thName').textContent = t.thName;
      document.getElementById('thScore').textContent = t.thScore;
      document.getElementById('thDate').textContent = t.thDate;
      document.getElementById('scoresTip').textContent = t.scoresTip;
      // HS UI
      document.getElementById('hsCongrats').textContent = t.hsCongrats;
      document.getElementById('hsPrompt').textContent = t.hsPrompt;
      document.getElementById('saveScoreBtn').textContent = t.saveScore;
      document.getElementById('playerName').placeholder = t.namePlaceholder;
    }

    /********************
     * 1) Stedenlijst (>250k in Europa)
     ********************/
    const CITIES = [
      ["Amsterdam","Nederland",52.3676,4.9041],["Rotterdam","Nederland",51.9225,4.47917],["Den Haag","Nederland",52.0705,4.3007],["Utrecht","Nederland",52.0907,5.1214],["Eindhoven","Nederland",51.4416,5.4697],["Antwerpen","Belgi√´",51.2194,4.4025],["Brussel","Belgi√´",50.8503,4.3517],["Gent","Belgi√´",51.0543,3.7174],["Paris","Frankrijk",48.8566,2.3522],["Marseille","Frankrijk",43.2965,5.3698],["Lyon","Frankrijk",45.7640,4.8357],["Toulouse","Frankrijk",43.6047,1.4442],["Nice","Frankrijk",43.7102,7.2620],["Nantes","Frankrijk",47.2184,-1.5536],["Strasbourg","Frankrijk",48.5734,7.7521],["Montpellier","Frankrijk",43.6119,3.8772],["Bordeaux","Frankrijk",44.8378,-0.5792],["Madrid","Spanje",40.4168,-3.7038],["Barcelona","Spanje",41.3874,2.1686],["Valencia","Spanje",39.4699,-0.3763],["Sevilla","Spanje",37.3891,-5.9845],["Zaragoza","Spanje",41.6488,-0.8891],["M√°laga","Spanje",36.7213,-4.4214],["Murcia","Spanje",37.9922,-1.1307],["Bilbao","Spanje",43.2630,-2.9350],["Alicante","Spanje",38.3452,-0.4810],["Lisboa","Portugal",38.7223,-9.1393],["Porto","Portugal",41.1579,-8.6291],["Vila Nova de Gaia","Portugal",41.1336,-8.6174],["London","VK",51.5074,-0.1278],["Birmingham","VK",52.4862,-1.8904],["Manchester","VK",53.4808,-2.2426],["Leeds","VK",53.8008,-1.5491],["Liverpool","VK",53.4084,-2.9916],["Sheffield","VK",53.3811,-1.4701],["Glasgow","VK",55.8642,-4.2518],["Edinburgh","VK",55.9533,-3.1883],["Bristol","VK",51.4545,-2.5879],["Nottingham","VK",52.9548,-1.1581],["Leicester","VK",52.6369,-1.1398],["Belfast","VK",54.5973,-5.9301],["Dublin","Ierland",53.3498,-6.2603],["Berlin","Duitsland",52.5200,13.4050],["Hamburg","Duitsland",53.5511,9.9937],["M√ºnchen","Duitsland",48.1351,11.5820],["K√∂ln","Duitsland",50.9375,6.9603],["Frankfurt am Main","Duitsland",50.1109,8.6821],["Stuttgart","Duitsland",48.7758,9.1829],["D√ºsseldorf","Duitsland",51.2277,6.7735],["Dortmund","Duitsland",51.5136,7.4653],["Essen","Duitsland",51.4556,7.0116],["Leipzig","Duitsland",51.3397,12.3731],["Dresden","Duitsland",51.0504,13.7373],["Hannover","Duitsland",52.3759,9.7320],["N√ºrnberg","Duitsland",49.4521,11.0767],["Bremen","Duitsland",53.0793,8.8017],["Athens","Griekenland",37.9838,23.7275],["Thessaloniki","Griekenland",40.6401,22.9444],["Sofia","Bulgarije",42.6977,23.3219],["Plovdiv","Bulgarije",42.1354,24.7453],["Varna","Bulgarije",43.2141,27.9147],["Bucure»ôti","Roemeni√´",44.4268,26.1025],["Cluj-Napoca","Roemeni√´",46.7712,23.6236],["Timi»ôoara","Roemeni√´",45.7489,21.2087],["Ia»ôi","Roemeni√´",47.1585,27.6014],["Wien","Oostenrijk",48.2082,16.3738],["Graz","Oostenrijk",47.0707,15.4395],["Praha","Tsjechi√´",50.0755,14.4378],["Brno","Tsjechi√´",49.1951,16.6068],["Ostrava","Tsjechi√´",49.8209,18.2625],["Bratislava","Slovakije",48.1486,17.1077],["Budapest","Hongarije",47.4979,19.0402],["Zagreb","Kroati√´",45.8150,15.9819],["Ljubljana","Sloveni√´",46.0569,14.5058],["Beograd","Servi√´",44.7866,20.4489],["Novi Sad","Servi√´",45.2671,19.8335],["Sarajevo","Bosni√´ en Herzegovina",43.8563,18.4131],["Skopje","Noord-Macedoni√´",41.9973,21.4280],["Tirana","Albani√´",41.3275,19.8187],["Roma","Itali√´",41.9028,12.4964],["Milano","Itali√´",45.4642,9.1900],["Napoli","Itali√´",40.8518,14.2681],["Torino","Itali√´",45.0703,7.6869],["Palermo","Itali√´",38.1157,13.3613],["Genova","Itali√´",44.4056,8.9463],["Bologna","Itali√´",44.4949,11.3426],["Firenze","Itali√´",43.7696,11.2558],["Bari","Itali√´",41.1171,16.8719],["Catania","Itali√´",37.5079,15.0830],["Verona","Itali√´",45.4384,10.9916],["Venezia","Itali√´",45.4408,12.3155],["Warschau","Polen",52.2297,21.0122],["Krak√≥w","Polen",50.0647,19.9450],["≈Å√≥d≈∫","Polen",51.7592,19.4550],["Wroc≈Çaw","Polen",51.1079,17.0385],["Pozna≈Ñ","Polen",52.4064,16.9252],["Gda≈Ñsk","Polen",54.3520,18.6466],["Stockholm","Zweden",59.3293,18.0686],["G√∂teborg","Zweden",57.7089,11.9746],["Malm√∂","Zweden",55.605,13.0038],["Oslo","Noorwegen",59.9139,10.7522],["Bergen","Noorwegen",60.393,5.3242],["K√∏benhavn","Denemarken",55.6761,12.5683],["Aarhus","Denemarken",56.1629,10.2039],["Helsinki","Finland",60.1699,24.9384],["Espoo","Finland",60.2055,24.6559],["Vilnius","Litouwen",54.6872,25.2797],["Kaunas","Litouwen",54.8985,23.9036],["Rƒ´ga","Letland",56.9496,24.1052],["Tallinn","Estland",59.437,24.7536],["Z√ºrich","Zwitserland",47.3769,8.5417],["Gen√®ve","Zwitserland",46.2044,6.1432],["Bern","Zwitserland",46.948,7.4474],["Kyiv","Oekra√Øne",50.4501,30.5234],["Kharkiv","Oekra√Øne",49.9935,36.2304],["Odesa","Oekra√Øne",46.4825,30.7233],["Dnipro","Oekra√Øne",48.4647,35.0462],["Minsk","Belarus",53.9006,27.559],["Moskva","Rusland",55.7558,37.6173],["Sankt-Peterburg","Rusland",59.9343,30.3351],["ƒ∞stanbul","Turkije",41.0082,28.9784]
    ];

    /********************
     * 2) Helpers & Highscores
     ********************/
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function pickTen(){ return shuffle([...CITIES]).slice(0,10).map(c => ({name:c[0], country:c[1], lat:c[2], lon:c[3]})); }
    function fmtKm(k){ return (Math.round(k*10)/10).toFixed(1); }

    const storageKey = 'geoguess-eu-top10-v1';
    function loadScores(){ try{ return JSON.parse(localStorage.getItem(storageKey))||[]; }catch(e){ return []; } }
    function saveScores(list){ localStorage.setItem(storageKey, JSON.stringify(list)); }
    function isHighscore(totalKm){
      const list = loadScores();
      if(list.length < 10) return true;
      const worst = list.reduce((m,e)=> Math.max(m, Number(e.score)||Infinity), -Infinity);
      return totalKm < worst;
    }
    function addHighscore(name, totalKm){
      const entry = { name: (name||'‚Äî').toString().slice(0,40), score: Math.round(totalKm*10)/10, date: new Date().toISOString().slice(0,10) };
      const list = loadScores();
      list.push(entry);
      list.sort((a,b)=> Number(a.score) - Number(b.score));
      const top10 = list.slice(0,10);
      saveScores(top10);
      renderScores();
    }
    function renderScores(){
      const body = document.getElementById('scoresBody');
      const list = loadScores();
      body.innerHTML = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.score}</td><td>${e.date}</td></tr>`).join('');
    }

    /********************
     * 3) ArcGIS kaart initialiseren
     ********************/
    require([
      'esri/Map','esri/views/MapView','esri/Graphic','esri/layers/GraphicsLayer',
      'esri/geometry/Polyline','esri/geometry/SpatialReference','esri/geometry/Point','esri/geometry/geometryEngine',
      'esri/geometry/support/webMercatorUtils'
    ], function(Map, MapView, Graphic, GraphicsLayer, Polyline, SpatialReference, Point, geometryEngine, webMercatorUtils){
      const map = new Map({ basemap: 'satellite' });
      const view = new MapView({ container: 'viewDiv', map, center: [10, 50], zoom: 4, constraints: { snapToZoom:false } });

      const gl = new GraphicsLayer(); map.add(gl);

      // UI refs
      const roundEl = document.getElementById('round');
      const totalEl = document.getElementById('totalKm');
      const cityEl = document.getElementById('cityName');
      const feedbackEl = document.getElementById('feedback');
      const nextBtn = document.getElementById('nextBtn');
      const restartBtn = document.getElementById('restartBtn');
      const showScoresBtn = document.getElementById('showScoresBtn');
      const scoresDiv = document.getElementById('scores');
            const banner = document.getElementById('banner');
      const toast = document.getElementById('toast');
      const langSelect = document.getElementById('langSelect');
      const nameEntry = document.getElementById('nameEntry');
      const playerNameInput = document.getElementById('playerName');
      const saveScoreBtn = document.getElementById('saveScoreBtn');

      // init language UI
      langSelect.value = CUR_LANG; applyI18n();
      langSelect.addEventListener('change', ()=>{
        CUR_LANG = langSelect.value; localStorage.setItem(LANG_KEY, CUR_LANG); applyI18n(); setCityBanner();
      });

      renderScores();

      let rounds = [];
      let idx = 0;
      let totalKm = 0;
      let awaitingClick = true;

      function showToast(msg){
        toast.textContent = msg; toast.style.display = 'block';
        setTimeout(()=>toast.style.display='none', 2000);
      }

      function toWGS84(pt){
        if(!pt) return pt;
        const sr = pt.spatialReference;
        if(sr && sr.isWGS84) return pt;
        if(sr && sr.isWebMercator) return webMercatorUtils.webMercatorToGeographic(pt);
        return pt;
      }

      function startGame(){
        rounds = pickTen();
        idx = 0; totalKm = 0; awaitingClick = true;
        totalEl.textContent = fmtKm(totalKm);
        roundEl.textContent = 1;
        nextBtn.disabled = true; scoresDiv.style.display = 'none'; gl.removeAll();
        nameEntry.style.display = 'none'; playerNameInput.value = '';
        setCityBanner(); focusEurope();
        banner.textContent = T().bannerSearch(rounds[0].name);
        feedbackEl.textContent = T().feedbackReady;
        showToast(T().toastNew);
      }

      function setCityBanner(){
        const r = rounds[idx];
        cityEl.textContent = `${r.name}`;
        feedbackEl.textContent = T().feedbackReady;
        banner.textContent = T().bannerSearch(r.name);
      }

      function focusEurope(){
        view.goTo({ center:[10,50], zoom:4 }, {animate:true, duration:800}).catch(()=>{});
      }

      function nextRound(){
        idx++;
        if(idx>=rounds.length){ endGame(); return; }
        roundEl.textContent = (idx+1);
        awaitingClick = true; nextBtn.disabled = true; gl.removeAll();
        setCityBanner(); focusEurope();
      }

      function endGame(){
        const t = T();
        banner.textContent = t.bannerEnd;
        feedbackEl.innerHTML = t.endMsg(fmtKm(totalKm));
        cityEl.textContent = '‚Äî'; awaitingClick = false; nextBtn.disabled = true;
        // Highscore check
        if (isHighscore(totalKm)) {
          nameEntry.style.display = 'block';
          playerNameInput.focus();
        }
        showToast(t.toastOver);
      }

      function addMarker(point, color, text){
        const symbol = { type:'simple-marker', size: 10, color, outline:{ color:'#fff', width:1 } };
        const g = new Graphic({ geometry: point, symbol, attributes:{text}, popupTemplate: text?{title:text}:null });
        gl.add(g); return g;
      }

      function addLine(p1, p2){
        const line = new Polyline({ spatialReference: SpatialReference.WGS84, paths: [[[p1.longitude, p1.latitude],[p2.longitude, p2.latitude]]] });
        const g = new Graphic({ geometry: line, symbol: { type:'simple-line', width:2, color:[20,100,244,0.9] } }); gl.add(g); return line;
      }

      view.on('click', (ev)=>{
        if(!awaitingClick) return;
        const r = rounds[idx];
        const guess = toWGS84(ev.mapPoint);
        const target = new Point({ longitude: r.lon, latitude: r.lat, spatialReference: SpatialReference.WGS84 });

        addMarker(target, [30,200,90], `${r.name}`);
        addMarker(guess, [230,60,60], T().yourGuess);
        const line = addLine(guess, target);
        const km = geometryEngine.geodesicLength(line, 'kilometers');

        totalKm += km; totalEl.textContent = fmtKm(totalKm);
        feedbackEl.innerHTML = T().roundDist(fmtKm(km));
        banner.textContent = T().roundBanner(idx+1, fmtKm(km));
        awaitingClick = false; nextBtn.disabled = false;

        view.goTo({ target: [guess, target], zoom: view.zoom }, { animate:true, duration: 1000 }).catch(()=>{});
      });

      nextBtn.addEventListener('click', nextRound);
      restartBtn.addEventListener('click', ()=>{ startGame(); });
      showScoresBtn.addEventListener('click', ()=>{
        scoresDiv.style.display = scoresDiv.style.display==='none' ? 'block' : 'none';
        if(scoresDiv.style.display==='block') renderScores();
      });
      saveScoreBtn.addEventListener('click', ()=>{
        addHighscore(playerNameInput.value.trim() || 'Speler', totalKm);
        nameEntry.style.display = 'none';
        scoresDiv.style.display = 'block';
        renderScores();
      });
      playerNameInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') { e.preventDefault(); document.getElementById('saveScoreBtn').click(); }
      });

      

      // Start
      document.getElementById('langSelect').value = CUR_LANG; applyI18n();
      startGame();
    });
  </script>
</body>
</html>
